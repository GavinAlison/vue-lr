# MySQL太慢？试试这些诊断思路和工具

如果遇到 MySQL 慢的话，你的第一印象是什么，如果MySQL 数据库性能不行，你是如何处理的？

# MySQL 慢怎么办

我咨询了一些同行, 得到了以下反馈：

- 第一反应是再试一次
- 第二个反应是优化一下 SQL
- 第三个反应是调大 buffer pool，然后开始换硬件了，换一下 SSD
- 最后实在不行了找个搜索引擎搜索一下"MySQL 慢怎么办"
  
如果大家用的是国内的搜索引擎的话，搜索引擎会推荐某某知道或者某某乎, 推荐一些 MySQL 调优经验, 调大参数 A, 调低参数 B, 诸如此类，类似的网站能告诉你 MySQL 慢怎么办。

我们来分析一下这些现象背后隐藏的意义：

- 如果再试一次能够成功的话, 意味着你可能碰到了不可复现的外界因素的影响，导致 MySQL 会慢。
- 如果优化 SQL 能解决，就意味着 SQL 的执行复杂度远远大于它的需求复杂度。
- 如果调大 buffer pool 能解决，就意味着 MySQL 碰到了自身的某些限制。
- 如果换 SSD 能解决，那么意味着服务器资源受到了一定的限制。
- 如果需要搜索引擎，意味着调优这事已经变成了玄学。

本文向大家分享我对 MySQL 慢的诊断思路，以及向大家介绍系统观测工具。

# MySQL 慢的诊断思路

MySQL 慢的诊断思路，一般会从三个方向来做：

1. MySQL 内部的观测
2. 外部资源的观测
3. 外部需求的改造

## MySQL 内部观测

**********************************重要的东西****************************************
常用的 MySQL 内部观测手段是这样的：

- 第一步是 Processlist，看一下哪个 SQL 压力不太正常；
- 第二步是 explain，解释一下它的执行计划；
- 第三步要做 Profilling，如果这个 SQL 能再执行一次的话, 就做一个 Profilling；
- 高级的 DBA 会直接动用 performance_schema ，MySQL 5.7 以后直接动用 sys_schema，sys_schema 是一个视图，里面有便捷的各类信息，帮助大家来诊断性能；
- 再高级一点，会动用 innodb_metrics 进行一个对引擎的诊断。

除了这些手段以外，还有一些乱七八糟的手段就不列在这了，这些是常规的 MySQL 内部状态观测的思路。
**********************************************************************************

## 外部资源观测

这里引用国外一个大神写的文章，标题是《60 秒的快速巡检》（参考链接在文末）。我们来看一下它在 60 秒之内对服务器到底做了一个什么样的巡检。一共十条命令，下面一条一条来看一下。

1. uptime，uptime 告诉我们这个机器活了多久，以及它的平均负载是多少。
2. dmesg -T | tail，告诉我们系统日志里边有没有什么报错。
3. vmstat 1，告诉我们虚拟内存的状态，页的换进换出有没有问题，swap 有没有使用。
4. mpstat -P ALL 1，告诉我们 CPU 压力在各个核上是不是均匀的。
5. pidstat 1，告诉我们各个进程的对资源的占用大概是什么样子。
6. iostat-xz 1，查看 IO 的问题。
7. free-m 内存使用率；
8. sar-n DVE 1，
9. sar-n TCP, ETCP 1，8 和 9 两条按设备网卡设备的维度，看一下网络的消耗状态，以及总体看 TCP 的使用率和错误率是多少。
10. top，看一下大概的进程和线程的问题。

这个就是对于外部资源的诊断，这十条命令揭示了应该去诊断哪些外部资源。

## 外部需求改造

根据业务将子查询 改造成 left join 查询

## 系统观测工具介绍

一堆工具，perf 和 ftrace，sysdig， eBPF， Systemtap


> 60 秒的快速巡检：
> 1.https://medium.com/netflix-techblog/linux-performance-analysis-in-60-000-milliseconds-accc10403c55
> 2.本文 PPT 下载链接：github.com/actiontech/slides
> 3.https://mp.weixin.qq.com/s?__biz=MzI0MDQ4MTM5NQ==&mid=2247487112&idx=1&sn=00f17802b225944d656ad0995341c3c8&chksm=e91b6b94de6ce282b033a0b2c21382462ccc7f026ab72576b0a79ac510570c0878e7180ca096&token=821580240&lang=zh_CN#rd
