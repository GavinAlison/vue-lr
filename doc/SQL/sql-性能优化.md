# 性能优化

Java层面的性能优化，针对java层面的，添加依赖

## 常见优化思路（先演示线上问题分析）

性能优化是服务治理里很重要的内容，优化是根据当时的服务压力情况及资源分配情况而做的相应调整，是一个循序渐进的过程。
虽然性能日志为优化提供了重要的线索，出现性能问题的场景却是很繁杂，一种优化方案在某场合可能会提升性能，
而另一种场合确成了性能瓶颈，因此具体问题要具体分析，结合上下文来分析，最终找到解决方案。
另建议初级开发人员多做这类的分析及优化，过程中能快速提升内功。
下面整理了一些常见的场景下的性能优化思路。

1. 使用批量接口

开发中经常遇到for循环中作网络调用，形如:

网站io都ms级别的，假设一次网络调用需要2ms，1000次就是 2*1000=2s（这还没算服务端的开销）。
因此RD在写出这样的代码时一定要警惕，循环次数会不会超过50，超过了就不能这么写。
走批量接口。redis有multi set ，dubbo调用得要求服务端提供批量接口，mysql也支持批量操作。

2. mysql/mongodb 等B+树 慢sql查询

a) 熟用explain
b) 联合索引、最左前缀匹配
c) 深分页问题
d) 读写分离、分库分表(cobar mycat ) 、数据迁移

3. 使用缓存

读多写少，高并发，缓存命中率高且满足业务，可使用缓存技术（建议不要使用本地cache）。
缓存设计时，粒度不宜过大，多个接口能复用数据，活用缓存策略，努力提升命中率。 
缓存代码的位置也有讲究，一般有三种方案：

（1）缓存代码加在client.jar（咱们这边叫api.jar）中，
优点：
对provider保护最好，缓存命中的请求不会打到provider机器上，不仅减少网络开销，也减轻了provider的压力；

缺点：
provider开发人员需要维护client代码，且升级时会有沟通成本。

（2）缓存代码加在反向代理服务器内，如 nginx+lua+redis，
优点：
对provider保护较好，缓存命中的请求直接从ng返回，不需要打到provider机器上；

缺点：
维护成本高，应用场景较窄。

（3）缓存代码加在服务端程序里，
优点：好维护；
缺点：所有请求都会打到provider机器上，压力较大。

有的场景加缓存是起不到作用的，反而会增加一次网络开销，我们需要关注缓存命中率，太低或存在缓存穿透都是需要调整的。

4. 同步改异步

（1）独立模块异步化
（2）系统间交互使用MQ替代同步调用

5、减少锁竞争，锁的粒度尽量小；线程不宜开太多，避免频繁的上下文切换

6、复用资源对象，避免重复创建、销毁的开销。

7、其它